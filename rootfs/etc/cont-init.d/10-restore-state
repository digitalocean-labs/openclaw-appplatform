#!/command/with-contenv bash
# Restore state from DO Spaces backup (if configured)

set -e

# Ensure directories exist
mkdir -p "$MOLTBOT_STATE_DIR" "$MOLTBOT_WORKSPACE_DIR" "$MOLTBOT_STATE_DIR/memory" "$TS_STATE_DIR"

# Skip if persistence not configured
if [ -z "$LITESTREAM_ACCESS_KEY_ID" ] || [ -z "$SPACES_BUCKET" ]; then
  echo "[restore-state] Persistence not configured, skipping restore"
  exit 0
fi

echo "[restore-state] Restoring state from Spaces backup..."

# Configure s3cmd for DO Spaces
cat > /tmp/.s3cfg << EOF
[default]
access_key = ${LITESTREAM_ACCESS_KEY_ID}
secret_key = ${LITESTREAM_SECRET_ACCESS_KEY}
host_base = ${SPACES_ENDPOINT}
host_bucket = %(bucket)s.${SPACES_ENDPOINT}
use_https = True
EOF

# Restore moltbot state files (config, devices, sessions) via tar
STATE_BACKUP_PATH="s3://${SPACES_BUCKET}/moltbot/state-backup.tar.gz"
if s3cmd -c /tmp/.s3cfg ls "$STATE_BACKUP_PATH" 2>/dev/null | grep -q state-backup; then
  echo "[restore-state] Downloading moltbot state backup..."
  s3cmd -c /tmp/.s3cfg get "$STATE_BACKUP_PATH" /tmp/state-backup.tar.gz && \
    tar -xzf /tmp/state-backup.tar.gz -C "$MOLTBOT_STATE_DIR" || \
    echo "[restore-state] Warning: failed to restore moltbot state backup (continuing)"
  rm -f /tmp/state-backup.tar.gz
else
  echo "[restore-state] No moltbot state backup found (first deployment)"
fi

# Restore Tailscale state
TS_BACKUP_PATH="s3://${SPACES_BUCKET}/moltbot/tailscale-state.tar.gz"
if s3cmd -c /tmp/.s3cfg ls "$TS_BACKUP_PATH" 2>/dev/null | grep -q tailscale-state; then
  echo "[restore-state] Downloading Tailscale state backup..."
  s3cmd -c /tmp/.s3cfg get "$TS_BACKUP_PATH" /tmp/tailscale-state.tar.gz && \
    tar -xzf /tmp/tailscale-state.tar.gz -C "$TS_STATE_DIR" || \
    echo "[restore-state] Warning: failed to restore Tailscale state backup (continuing)"
  rm -f /tmp/tailscale-state.tar.gz
else
  echo "[restore-state] No Tailscale state backup found (first deployment)"
fi

# Restore SQLite memory database via Litestream
echo "[restore-state] Restoring SQLite from Litestream..."
litestream restore -if-replica-exists -config /etc/litestream.yml \
  "$MOLTBOT_STATE_DIR/memory/main.sqlite" || true

echo "[restore-state] State restoration complete"
