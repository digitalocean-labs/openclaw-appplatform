#!/command/with-contenv bash
# Periodic backup service using restic

# Source s6 container environment (ensures vars are available)
for f in /run/s6/container_environment/*; do
  [ -f "$f" ] && export "$(basename $f)"="$(cat $f)"
done

CONFIG_FILE="/etc/moltbot/backup.yaml"

# Skip if persistence not configured
if [ -z "$RESTIC_REPOSITORY" ] || [ -z "$RESTIC_PASSWORD" ]; then
  echo "[backup] Persistence not configured, service disabled"
  s6-svc -Od .
  exit 0
fi

# Read backup interval from config (default 30 seconds)
BACKUP_INTERVAL=$(yq -r '.backup_interval_seconds // 30' "$CONFIG_FILE")
echo "[backup] Starting backup loop (every ${BACKUP_INTERVAL}s)..."

while true; do
  sleep "$BACKUP_INTERVAL"
  /usr/local/bin/restic-backup
done
