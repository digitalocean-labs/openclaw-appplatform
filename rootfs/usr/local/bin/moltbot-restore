#!/command/with-contenv bash
# Unified restore script for moltbot state using s3cmd sync
# Restores from s3://bucket/moltbot/rootfs/ preserving filesystem paths
#
# Usage:
#   moltbot-restore                   # Restore all default paths
#   moltbot-restore --path /some/dir  # Restore specific path
#   moltbot-restore --quiet           # Suppress output

set -e

QUIET=""
CUSTOM_PATH=""
S3_PREFIX="moltbot/rootfs"

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --quiet|-q)
      QUIET="true"
      shift
      ;;
    --path|-p)
      CUSTOM_PATH="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: moltbot-restore [--quiet] [--path /some/dir]"
      exit 1
      ;;
  esac
done

log() {
  if [ "$QUIET" != "true" ]; then
    echo "[restore] $1"
  fi
}

# Skip if persistence not configured
if [ -z "$LITESTREAM_ACCESS_KEY_ID" ] || [ -z "$SPACES_BUCKET" ]; then
  log "Persistence not configured, skipping restore"
  exit 0
fi

# Ensure s3cmd config exists
ensure_s3cfg() {
  if [ ! -f /tmp/.s3cfg ]; then
    cat > /tmp/.s3cfg << EOF
[default]
access_key = ${LITESTREAM_ACCESS_KEY_ID}
secret_key = ${LITESTREAM_SECRET_ACCESS_KEY}
host_base = ${SPACES_ENDPOINT}
host_bucket = %(bucket)s.${SPACES_ENDPOINT}
use_https = True
EOF
    chmod 600 /tmp/.s3cfg
  fi
}

# Restore a single path using s3cmd sync
# Restores filesystem path structure: s3://bucket/moltbot/rootfs/home/ -> /home
# Args: $1 = target path
restore_path() {
  local target_path="$1"
  
  # Remove leading slash for S3 path
  local s3_path="${target_path#/}"
  local s3_full="s3://${SPACES_BUCKET}/${S3_PREFIX}/${s3_path}/"
  
  # Ensure target directory exists
  mkdir -p "$target_path"
  
  # Check if backup exists in S3
  if s3cmd -c /tmp/.s3cfg ls "$s3_full" 2>/dev/null | grep -q .; then
    log "Syncing $s3_full to $target_path..."
    # Note: not using --delete-removed on restore to preserve any local files
    s3cmd -c /tmp/.s3cfg sync \
      --no-preserve \
      "$s3_full" "${target_path}/" && \
      log "$target_path restored successfully" || \
      log "Warning: $target_path restore failed (continuing)"
  else
    log "No backup found for $target_path (first deployment)"
  fi
}

ensure_s3cfg

# If custom path specified, restore just that
if [ -n "$CUSTOM_PATH" ]; then
  restore_path "$CUSTOM_PATH"
  log "Restore complete"
  exit 0
fi

# Default: restore all known paths
# Ensure base directories exist
mkdir -p "$MOLTBOT_STATE_DIR" "$MOLTBOT_WORKSPACE_DIR" "$TS_STATE_DIR"

restore_path "$MOLTBOT_STATE_DIR"
restore_path "$TS_STATE_DIR"
restore_path "/home"

log "Restore complete"
