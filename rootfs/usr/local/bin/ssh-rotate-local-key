#!/bin/bash
# Rotate local SSH keys for all members of the localaccess group
# Keys are used for localhost SSH access between users
# All public keys are written to each user's ~/.ssh/authorized_keys
# Permissions are set via permissions.yaml

set -e

GROUP="localaccess"
PUBKEYS=""

# Ensure group exists
getent group "$GROUP" >/dev/null || {
  echo "[ssh-rotate] Group $GROUP does not exist"
  exit 1
}

# Get group members
MEMBERS=$(getent group "$GROUP" | cut -d: -f4 | tr ',' ' ')

if [ -z "$MEMBERS" ]; then
  echo "[ssh-rotate] No members in $GROUP group"
  exit 0
fi

# First pass: generate keys for each member and collect public keys
for user in $MEMBERS; do
  # Get user's home directory
  HOME_DIR=$(getent passwd "$user" | cut -d: -f6)
  if [ -z "$HOME_DIR" ]; then
    echo "[ssh-rotate] Warning: Could not find home directory for $user"
    continue
  fi

  SSH_DIR="$HOME_DIR/.ssh"
  KEY_FILE="$SSH_DIR/id_ed25519"

  # Ensure .ssh directory exists
  mkdir -p "$SSH_DIR"

  # Remove old key if it exists
  rm -f "$KEY_FILE" "$KEY_FILE.pub"

  # Generate new keypair
  ssh-keygen -t ed25519 -N "" -f "$KEY_FILE" -C "$user@localhost-$(date +%Y%m%d)" >/dev/null

  # Set ownership
  chown -R "$user:$user" "$SSH_DIR"

  # Collect public key
  PUBKEYS="$PUBKEYS$(cat "$KEY_FILE.pub")"$'\n'

  echo "[ssh-rotate] Generated SSH keypair for $user"
done

# Second pass: write all public keys to each user's authorized_keys
for user in $MEMBERS; do
  HOME_DIR=$(getent passwd "$user" | cut -d: -f6)
  if [ -z "$HOME_DIR" ]; then
    continue
  fi

  AUTH_KEYS="$HOME_DIR/.ssh/authorized_keys"

  # Write all local access public keys (preserving any existing external keys)
  # Use marker comments to identify local access keys
  if [ -f "$AUTH_KEYS" ]; then
    # Remove old local access keys (between markers)
    sed -i '/^# BEGIN LOCAL ACCESS KEYS$/,/^# END LOCAL ACCESS KEYS$/d' "$AUTH_KEYS"
  fi

  # Append local access keys with markers
  {
    echo "# BEGIN LOCAL ACCESS KEYS"
    echo -n "$PUBKEYS"
    echo "# END LOCAL ACCESS KEYS"
  } >> "$AUTH_KEYS"

  chown "$user:$user" "$AUTH_KEYS"
  chmod 600 "$AUTH_KEYS"

  echo "[ssh-rotate] Updated authorized_keys for $user"
done

echo "[ssh-rotate] All localaccess members can now SSH to each other"
